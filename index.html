<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
	border: 1px solid #d3d3d3;
	background: radial-gradient(rgba(0, 0, 0, .7), rgba(0, 0, 0, 1));	
	display: block;
}
</style>
<script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBS3KiF_kDKclhxeXZMZSQbhqS_Hdtda84",
    authDomain: "quantumsoccer-8eac7.firebaseapp.com",
    databaseURL: "https://quantumsoccer-8eac7.firebaseio.com",
    projectId: "quantumsoccer-8eac7",
    storageBucket: "quantumsoccer-8eac7.appspot.com",
    messagingSenderId: "530051774265"
  };
  firebase.initializeApp(config);
</script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
<!-- AngularFire -->
<script src="https://cdn.firebase.com/libs/angularfire/2.1.0/angularfire.min.js"></script>
<!-- Your Javascript -->
<script src="script.js"></script>
</head>
<body>

<script>
var gameId;
var player;
var goal1;
var goal2;
var ball;
var player1;
var player2;
var score1;
var score2;
var points1 = 0;
var points2 = 0;
var color1
var color2
var db = firebase.database()
db.ref('waiting').orderByChild('gameId').once('value', function(snapshot) {
	if (snapshot.val()) {
		gameId = snapshot.val().gameId;
		color1 = snapshot.val().color;
		console.log(gameId);
		player = 2;
		snapshot.ref.remove();
		db.ref('games/' + gameId).set({ready: "true"});
		startGame();
	}
	else {
		gameId = createUUID();
		color1 = '#'+(Math.random()*0xFFFFFF<<0).toString(16);
		player = 1;
		db.ref('waiting').set({
			gameId: gameId, 
			color: color1
		});
		waitForOponent();
	}
});

function waitForOponent() {
	var ref = db.ref('games/' + gameId);
	ref.orderByKey().once("child_changed", function(snapshot) {
		startGame();
	});
}

function startGame() {
  myGameArea.start();
  color2 = invertHex(color1);
  goal1 = new component(100, 200, color1, 700, 175);
  goal2 = new component(100, 200, color2, 0, 175);
  ball = new component(40, 40, "ball.png", 400, 250, "image");
  player1 = new component(30, 30, color1, 350, 250);
  player2 = new component(30, 30, color2, 450, 250)
  score1  = new component("30px", "Consolas", "white", 650, 50, "text");
  score2 = new component("30px", "Consolas", "white", 50, 50, "text");
  setDBListeners();
	var ref = db.ref('games/' + gameId + '/comp/ball')
	ref.set({
		x: ball.x,
		y: ball.y,
	});
}

function setDBListeners() {	
	var ref = db.ref('games/' + gameId + "/comp")
	ref.orderByKey().on("child_changed", function(data) {
	var comp = data.val()
	console.log(data.key);
	if (data.key == "ball") {
		ball = new component(40, 40, "ball.png", comp.x, comp.y, "image")	
	} else if (data.key == "1" && player == 2) {
		player1 = new component(30, 30, color1, comp.x, comp.y);
	} else if (data.key == "2" && player == 1) {
		player2 = new component(30, 30, color2, comp.x, comp.y);
	}
  });
}

var myGameArea = {
	canvas: document.createElement("canvas"),
	start : function() {
		this.canvas.width = 800;
		this.canvas.height = 500;
		this.context = this.canvas.getContext("2d");
		document.body.insertBefore(this.canvas, document.body.childNodes[0]);
		this.interval = setInterval(updateGameArea, 20);
		window.addEventListener('keydown', function(e) {
			myGameArea.keys = (myGameArea.keys || []);
			myGameArea.keys[e.keyCode] = true;
		})
		window.addEventListener('keyup', function(e) {
			myGameArea.keys[e.keyCode] = false;
		})
	},
	clear : function() {
		this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
	}
}

function component(width, height, color, x, y, type) {
        if (type == "image") {
		this.image = new Image();
		this.image.src = color;
	}
	this.width = width;
	this.height = height;
	this.x = x;
	this.y = y;
	this.update = function(player) {
		ctx = myGameArea.context;
		if (type == "image") {
			ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
		} else if (type == "text") {
			ctx.font = this.width + " " + this.height;
			ctx.fillStyle = color;
			ctx.fillText(this.text, this.x, this.y);
		} else {
			ctx.fillStyle = color;
			ctx.fillRect(this.x, this.y, this.width, this.height);
		}
	}
}

function move(play) {
	if (myGameArea.keys[37]) {play.x -= 3;}
	if (myGameArea.keys[39]) {play.x += 3;}
	if (myGameArea.keys[38]) {play.y -= 3;}
	if (myGameArea.keys[40]) {play.y += 3;}
	if (myGameArea.keys[32]) {
		if (play.x >= ball.x - play.width &&
		    play.x <= ball.x + ball.width + play.width/3 &&
		    play.y <= ball.y + ball.height + play.height/3 && 
		    play.y >= ball.y - play.height) {
			ball.x += 1.5 * (ball.x - play.x)
			ball.y += 1.5 * (ball.y - play.y)
			var ref = db.ref('games/' + gameId + '/comp/ball')
			ref.set({
				x: ball.x,
				y: ball.y,
			});
		}
	}
}

function updateGameArea() {
	myGameArea.clear();
	if (myGameArea.keys) {
		if (player == 1) {
			 move(player1);
			 checkPlayerPosition(player1);
		} else  {
			move(player2)
			checkPlayerPosition(player2);
		}
	}
	checkBallPosition();	
	score1.text = "SCORE: " + points1;
	score2.text = "SCORE: " + points2;
	var ref = db.ref('games/' + gameId + '/comp/' + player);
	ref.set({
		x: player == 1 ? player1.x : player2.x,
		y: player == 1 ? player1.y : player2.y,
	});
	score1.update();
	score2.update();
	goal1.update();
	goal2.update();
	player1.update();
	player2.update();
	ball.update();
	if (points1 == 3 || points2 == 3) {
		clearInterval(myGameArea.interval);
		gameOver();
	}
}

function checkPlayerPosition(play) {
	if (play.x < -play.width + 1) play.x = -play.width + 1;
	if (play.y < -play.height + 1) play.y = -play.height + 1;
	if (play.x > myGameArea.canvas.width - 1) play.x = myGameArea.canvas.width - 1;
	if (play.y > myGameArea.canvas.height - 1) play.y = myGameArea.canvas.height - 1;
}

function checkBallPosition() {
	if (ball.x < 0) ball.x = 0; 
	if (ball.y < 0) ball.y = 0;
	if (ball.x > myGameArea.canvas.width - ball.width) ball.x = myGameArea.canvas.width - ball.width;
	if (ball.y > myGameArea.canvas.height - ball.height) ball.y = myGameArea.canvas.height - ball.height;
	
	//Check if ball is in goal1
	if (ball.x > 700 && ball.y > 150 && ball.y < 350) {
		points1  += 1;
		ball.x = 400;
		ball.y = 250;
	}
	//check to see if ball is in gaol2
	if (player2 && ball.x < 100 && ball.y > 150 && ball.y < 350) {
		points2 += 1;
		ball.x = 400;
		ball.y = 250;
	}
		
}

function gameOver() {
	myGameArea.clear();
	var interval = setInterval(winner(), 1000);
}

function winner() {
	var text;
	if (player == 1 && points1 == 3) text = "Congrats! You Won!";
	else if (player == 2 && points2 == 3) text = "Congrats! You Won!!";
	else text = "I'm Sorry, you lost :("
	ctx = myGameArea.context;
	ctx.font = "40px Consolas";
	ctx.fillStyle = "white";
	ctx.fillText(text, 200, 200);
	ctx.fillText("refresh the page to play again", 100, 275);
}
	
	


</script>
<h1 id="message"> Use arrow keys to move and space bar to kick! </h1>
</body>

</html>
