<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
canvas {
	border: 1px solid #d3d3d3;
	background-color: black;
}
</style>
<script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
<script>
  // Initialize Firebase
  var config = {
    apiKey: "AIzaSyBS3KiF_kDKclhxeXZMZSQbhqS_Hdtda84",
    authDomain: "quantumsoccer-8eac7.firebaseapp.com",
    databaseURL: "https://quantumsoccer-8eac7.firebaseio.com",
    projectId: "quantumsoccer-8eac7",
    storageBucket: "quantumsoccer-8eac7.appspot.com",
    messagingSenderId: "530051774265"
  };
  firebase.initializeApp(config);
</script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.8/angular.min.js"></script>
<!-- AngularFire -->
<script src="https://cdn.firebase.com/libs/angularfire/2.1.0/angularfire.min.js"></script>
<!-- Your Javascript -->
<script src="script.js"></script>
</head>
<body onload="startGame()">

<script>
var goal1;
var goal2;
var ball;
var player1;
var player2;
var uuid = createUUID();
console.log(uuid);
var score1;
var score2;
function startGame() {
  myGameArea.start();
  var color = '#'+(Math.random()*0xFFFFFF<<0).toString(16);
  goal1 = new component(100, 200, color, 700, 175);
  ball = new component(40, 40, "ball.png", 200, 175, "image");
  player1 = new component(30, 30, color, 175, 175);
  score1  = new component("30px", "Consolas", "white", 650, 50, "text");
  var ref = firebase.database().ref('comp')
  ref.orderByKey().on("child_changed", function(data) {
	var comp = data.val()
	if (data.key == "ball") {
		ball = new component(comp.width, comp.height, comp.color, comp.x, comp.y, comp.type)	
	} else if (data.key != uuid) {
		player2 = new component(comp.width, comp.height, comp.color, comp.x, comp.y)
		goal2 = new component(100, 200, comp.color, 0, 175);
		score2 = new component("30px", "Consolas", "white", 50, 50, "text");
	}

  });
}

var myGameArea = {
	canvas: document.createElement("canvas"),
	start : function() {
		this.canvas.width = 800;
		this.canvas.height = 500;
		this.context = this.canvas.getContext("2d");
		document.body.insertBefore(this.canvas, document.body.childNodes[0]);
		this.interval = setInterval(updateGameArea, 20);
		window.addEventListener('keydown', function(e) {
			myGameArea.keys = (myGameArea.keys || []);
			myGameArea.keys[e.keyCode] = true;
		})
		window.addEventListener('keyup', function(e) {
			myGameArea.keys[e.keyCode] = false;
		})
	},
	clear : function() {
		this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
	}
}

function component(width, height, color, x, y, type) {
	this.type = type;
	this.color = color;
	this.points = 0;
        if (type == "image") {
		this.image = new Image();
		this.image.src = color;
	}
	this.width = width;
	this.height = height;
	this.x = x;
	this.y = y;
	this.update = function(player) {
		ctx = myGameArea.context;
		if (type == "image") {
			ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
		} else if (type == "text") {
			ctx.font = this.width + " " + this.height;
			ctx.fillStyle = color;
			ctx.fillText(this.text, this.x, this.y);
		} else {
			ctx.fillStyle = color;
			ctx.fillRect(this.x, this.y, this.width, this.height);
		}
	}
}
function updateGameArea() {
	myGameArea.clear();
	if(myGameArea.keys) {
		if (myGameArea.keys[37]) {player1.x -= 4;}
		if (myGameArea.keys[39]) {player1.x += 4;}
		if (myGameArea.keys[38]) {player1.y -= 4;}
		if (myGameArea.keys[40]) {player1.y += 4;}
                if (myGameArea.keys[32]) {
			if (player1.x >= ball.x - player1.width &&
                            player1.x <= ball.x + ball.width + player1.width/3 &&
			    player1.y <= ball.y + ball.height + player1.height/3 && 
			    player1.y >= ball.y - player1.height) {
				ball.x += 3 * (ball.x - player1.x)
				ball.y += 3 * (ball.y - player1.y)
				firebase.database().ref('comp/ball/').set({
					width: ball.width,
					height: ball.height,
					color: ball.color,
					x: ball.x,
					y: ball.y,
					type: "image"
				});
			}
		}
	}
	checkPlayerPosition();
	checkBallPosition();	
	score1.text = "SCORE: " + player1.points;
	if(score2) score2.text = "SCORE: " + player2.points;
	firebase.database().ref('comp/' + uuid + '/').set({
		width: player1.width,
		height: player1.height,
		color: player1.color,
		x: player1.x,
		y: player1.y,
		score: player1.points
	});
	score1.update();
	goal1.update();
	player1.update();
	if(score2) score2.update();
	if(goal2) goal2.update();
	if (player2) player2.update();
	ball.update();
}

function checkPlayerPosition() {
	if (player1.x < -player1.width) player1.x = -player1.width;
	if (player1.y < -player1.height) player1.y = -player1.height;
	if (player1.x > myGameArea.canvas.width) player1.x = myGameArea.canvas.width;
	if (player1.y > myGameArea.canvas.height) player1.y = myGameArea.canvas.height;
}

function checkBallPosition() {
	if (ball.x < 0) ball.x = 0; 
	if (ball.y < 0) ball.y = 0;
	if (ball.x > myGameArea.canvas.width - ball.width) ball.x = myGameArea.canvas.width - ball.width;
	if (ball.y > myGameArea.canvas.height - ball.height) ball.y = myGameArea.canvas.height - ball.height;
	
	//Check if ball is in goal
	if (ball.x > 700 && ball.y > 150 && ball.y < 350) {
		player1.points += 1
		ball.x = 400;
		ball.y = 250;
	}
}

	


</script>
<h1 id="message"> Use arrow keys to move and space bar to kick! </h1>
</body>

</html>
